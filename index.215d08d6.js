function e(e){const t=document.getElementById(e),n=document.getElementById(e+"_output");if(null==t||null==n)return alert("Broken code example, unable to find code id: "+e),!1;const r=t?.value;return r?(n.innerHTML="",{output:n,text:r}):(n.innerHTML="Needs text input to parse",!1)}class t{constructor(e,t){this.value=e,this.name=t}typename(){return"builtin-function"}toString(){return`builtin-function:${this.name}`}compareTo(e){return e instanceof t&&this.value===e.value?0:1}invoke(e,t,n){this.value(e,t)}}class n{constructor(e){this.value=e}typename(){return"number"}toString(){return this.value.toString()}compareTo(e){return e instanceof n?r(this.value,e.value):1}}function r(e,t){const n=e-t;return Math.abs(n)<1e-4?0:n<0?-1:1}function s(e){return e instanceof n}class a{static Empty=new a(void 0);_values={};get values(){return this._values}constructor(e){this._parent=e}combineScope(e){for(const t in e.values)this.define(t,e.values[t])}define(e,t){this._values[e]=t}defineFunc(e,n,r=null){this._values[e]=new t(n,r??e)}set(e,t){return this._values.hasOwnProperty(e)?(this._values[e]=t,!0):!!this._parent&&this._parent.set(e,t)}get(e){const t=this._values[e];return null!=t?t:void 0!==this._parent?this._parent.get(e):void 0}getNumber(e){const t=this.get(e);if(s(t))return t.value}}class o{static True=new o(!0);static False=new o(!1);constructor(e){this.value=e}typename(){return"boolean"}toString(){return this.value?"true":"false"}compareTo(e){return e instanceof o?(t=this.value,n=e.value,t===n?0:t?-1:1):1;var t,n}}function i(e){return e instanceof o}const u=["length"];class c{constructor(e){this.value=e}typename(){return"string"}toString(){return this.value}compareTo(e){if(!(e instanceof c))return 1;const t=this.value.localeCompare(e.value);return 0==t?0:t<0?-1:1}getIndex(e){return e<0?this.value.length+e:e}tryGetKey(e){if("length"===e)return new n(this.value.length)}objectKeys(){return u}}function l(e){return e instanceof c}const h=["length"];class p{static Empty=new p([],!1);static EmptyArgs=new p([],!0);constructor(e,t=!1){this.value=e,this.isArgumentValue=t}typename(){return this.isArgumentValue?"arguments":"array"}toString(){let e=!0,t="(";for(const n of this.value)e||(t+=" "),e=!1,t+=n.toString();return t+=")",t}arrayValues(){return this.value}compareTo(e){return this===e?0:e instanceof p?function(e,t){const n=e.arrayValues(),s=t.arrayValues(),a=r(n.length,s.length);if(0!==a)return a;for(let e=0;e<n.length;e++){const t=n[e].compareTo(s[e]);if(0!==t)return t}return 0}(this,e):1}calcIndex(e){return e<0?this.value.length+e:e}tryGetIndex(e){return this.value[this.calcIndex(e)]}getIndex(e){if(e<0||e>=this.value.length)throw new Error("Out of index");return this.value[e]}getIndexCast(e,t){const n=this.value[e];if(t(n))return n;throw new Error(`Unable to get argument: [${e}] failed guard check`)}getNumber(e){return this.getIndexCast(e,s).value}getString(e){return this.getIndexCast(e,l).value}getBool(e){return this.getIndexCast(e,i).value}tryGetKey(e){if("length"===e)return new n(this.value.length)}objectKeys(){return h}}function g(e){return void 0!==e&&e instanceof p}function f(e){return void 0!==e&&"function"==typeof e.arrayValues}function S(e){return void 0!==e&&"function"==typeof e.invoke}class m{static Value=new m;typename(){return"null"}toString(){return"null"}compareTo(e){return e instanceof m?0:1}}class v{constructor(e){this.value=e,this.keys=Object.keys(e)}typename(){return"object"}toString(){let e=!0,t="{";for(const n in this.value)e||(t+=" "),e=!1,t+=`"${n}" `,t+=this.value[n].toString();return t+="}",t}compareTo(e){if(this===e)return 0;if(!(e instanceof v))return 1;const t=r(this.keys.length,e.keys.length);if(0!==t)return t;for(const t in this.value){const n=e.value[t];if(void 0===n)return 1;const r=this.value[t].compareTo(n);if(0!==r)return r}return 0}tryGetKey(e){return this.value[e]}objectKeys(){return this.keys}}function b(e){return void 0!==e&&e instanceof v}const k=function(){const e=new a,n={join:new t(((e,t)=>{e.pushStack(new p(t.value))}),"array.join"),length:new t(((e,t)=>{const n=t.getIndexCast(0,g);e.pushStackNumber(n.arrayValues().length)}),"array.length"),get:new t(((e,t)=>{const n=function(e,t){return e.tryGetIndex(t)}(t.getIndexCast(0,g),t.getNumber(1));void 0!==n?e.pushStack(n):e.pushStack(m.Value)}),"array.get"),set:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getNumber(1),s=t.getIndex(2);e.pushStack(function(e,t,n){let r=[...e.value];return r[e.calcIndex(t)]=n,new p(r)}(n,r,s))}),"array.set"),insert:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getNumber(1),s=t.getIndex(2);e.pushStack(function(e,t,n){t=e.calcIndex(t);const r=[...e.value];return r.splice(t,0,n),new p(r)}(n,r,s))}),"array.insert"),insertFlatten:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getNumber(1),s=t.getIndexCast(2,f);e.pushStack(function(e,t,n){t=e.calcIndex(t);const r=[...e.value];return r.splice(t,0,...n.arrayValues()),new p(r)}(n,r,s))}),"array.insertFlatten"),remove:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getIndex(1);e.pushStack(function(e,t){const n=d(e,t);return n<0?e:w(e,n)}(n,r))}),"array.remove"),removeAt:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getNumber(1);e.pushStack(w(n,r))}),"array.removeAt"),removeAll:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getIndex(1);e.pushStack(function(e,t){return new p(e.value.filter((e=>0!==e.compareTo(t))))}(n,r))}),"array.removeAll"),contains:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getIndex(1);e.pushStackBool(function(e,t){return d(e,t)>=0}(n,r))}),"array.contains"),indexOf:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getIndex(1);e.pushStackNumber(d(n,r))}),"array.indexOf"),sublist:new t(((e,t)=>{const n=t.getIndexCast(0,g),r=t.getNumber(1),s=t.getNumber(2);e.pushStack(y(n,r,s))}),"array.sublist")};return e.define("array",new v(n)),e}();function w(e,t){t=e.calcIndex(t);const n=[...e.value];return n.splice(t,1),new p(n)}function d(e,t){return e.arrayValues().findIndex((e=>0===e.compareTo(t)))}function y(e,t,n){return t=e.calcIndex(t),new p(n<0?e.value.slice(t):e.value.slice(t,t+n))}class x{get isLabel(){return this.value.length>0&&":"===this.value[0]}constructor(e){this.value=e}typename(){return"variable"}toString(){return this.value}compareTo(e){if(!(e instanceof x))return 1;const t=this.value.localeCompare(e.value);return 0==t?0:t<0?-1:1}}function N(e,t){const n=t.arrayValues();for(let t=0;t<n.length;t++){const s=C(n[t]);if(void 0!==s&&f(e)){const t=e.tryGetIndex(s);if(void 0===t)return;e=t}else{if(void 0===(r=e)||"function"!=typeof r.objectKeys)return;{const r=e.tryGetKey(n[t].toString());if(void 0===r)return;e=r}}}var r;return e}function C(e){if(e instanceof n)return e.value;if(e instanceof c||e instanceof x){const t=parseInt(e.value);return isFinite(t)?t:void 0}}class I{static Empty=new I([],[],{},"");get isEmpty(){return 0==this.code.length}constructor(e,t,n,r){this.code=e,this.parameters=t,this.labels=n,this.name=r.length>0?r:"anonymous",this.hasName=r.length>0}}class ${builtinScope=void 0;get globalScope(){return this._globalScope}_lineCounter=0;get lineCounter(){return this._lineCounter}running=!1;paused=!1;currentCode=I.Empty;_stack=[];get stack(){return this._stack}_stackTrace=[];get stackTrace(){return this._stackTrace}constructor(e){this._stackSize=e,this._globalScope=new a,this._currentScope=this._globalScope}reset(){this._globalScope=new a,this._currentScope=this._globalScope,this._lineCounter=0,this._stack=[],this._stackTrace=[],this.running=!1,this.paused=!1}changeToScript(e){this._lineCounter=0,this._stack=[],this._stackTrace=[],this.builtinScope=e.builtinScope,this.currentCode=e.code}execute(e){for(this.changeToScript(e),this.running=!0,this.paused=!1;this.running&&!this.paused;)this.step()}step(){if(this._lineCounter>=this.currentCode.code.length)return void(this.tryCallReturn()||(this.running=!1));const e=this.currentCode.code[this._lineCounter++];switch(e.operator){default:throw new Error(`Unknown operator: ${e.operator}`);case"push":if(void 0===e.value)throw new Error(`${this.getScopeLine()}: Push needs an input`);this.pushStack(e.value);break;case"toArgument":{const t=e.value??this.popStack();if(!f(t))throw new Error(`${this.getScopeLine()}: Unable to convert argument value onto stack: ${t.toString()}`);this.pushStack(new p(t.arrayValues(),!0));break}case"get":{const t=e.value??this.popStack();if(!(t instanceof c))throw new Error(`${this.getScopeLine()}: Unable to get, input must be a string not: ${t.toString()}`);let n=this._currentScope.get(t.value);if(void 0!==n){this.pushStack(n);break}if(void 0!==this.builtinScope&&(n=this.builtinScope.get(t.value),void 0!==n)){this.pushStack(n);break}throw new Error(`${this.getScopeLine()}: Unable to get variable: ${t.toString()}`)}case"getProperty":{const t=e.value??this.popStack();if(!f(t))throw new Error(`${this.getScopeLine()}: Unable to get property, input needs to be an array: ${t.toString()}`);const n=N(this.popStack(),t);if(void 0===n)throw new Error(`${this.getScopeLine()}: Unable to get property: ${t.toString()}`);this.pushStack(n);break}case"define":{const t=e.value??this.popStack(),n=this.popStack();this._currentScope.define(t.toString(),n);break}case"set":{const t=e.value??this.popStack(),n=this.popStack();if(!this._currentScope.set(t.toString(),n))throw new Error(`${this.getScopeLine()}: Unable to set variable that has not been defined: ${t.toString()} = ${n.toString()}`);break}case"jumpFalse":{const t=e.value??this.popStack();0===this.popStack().compareTo(o.False)&&this.jump(t.toString());break}case"jumpTrue":{const t=e.value??this.popStack();0===this.popStack().compareTo(o.True)&&this.jump(t.toString());break}case"jump":{const t=e.value??this.popStack();this.jump(t.toString());break}case"return":this.callReturn();break;case"call":{if(!(e.value instanceof n))throw new Error(`${this.getScopeLine()}: Call needs a num args code line input`);const t=e.value,r=this.popStack();if(!S(r))throw new Error(`${this.getScopeLine()}: Call needs a function to run: ${r.toString()}`);this.callFunction(r,t.value,!0);break}case"callDirect":{const t=e.value;if(!(null!=t&&f(t)&&S(t.tryGetIndex(0))&&t.tryGetIndex(1)instanceof n))throw new Error(`${this.getScopeLine()}: Call direct needs an array of the function and num args code line input`);this.callFunction(t.tryGetIndex(0),t.tryGetIndex(1).value,!0);break}case"stringConcat":{if(!s(e.value))throw new Error(`${this.getScopeLine()}: StringConcat operator needs the number of args to concat`);const t=this.getArgs(e.value.value);this.pushStackString(t.value.join(""));break}case"+":this.pushStackNumber(this.getNumArg(e)+this.popStackNumber());break;case"-":{const t=this.getNumArg(e),n=this.popStackNumber();this.pushStackNumber(n-t);break}case"unaryNegative":this.pushStackNumber(-this.popStackNumber());break;case"*":this.pushStackNumber(this.getNumArg(e)*this.popStackNumber());break;case"/":{const t=this.getNumArg(e),n=this.popStackNumber();this.pushStackNumber(n/t);break}case"++":{if(null==e.value)throw new Error(`${this.getScopeLine()}: Inc operator needs code line variable`);const t=e.value.toString(),r=this._currentScope.getNumber(t);if(void 0===r)throw new Error(`${this.getScopeLine()}: Inc operator could not find variable: ${t}`);this._currentScope.set(t,new n(r+1));break}case"--":{if(null==e.value)throw new Error(`${this.getScopeLine()}: Dec operator needs code line variable`);const t=e.value.toString(),r=this._currentScope.getNumber(t);if(void 0===r)throw new Error(`${this.getScopeLine()}: Dec operator could not find variable: ${t}`);this._currentScope.set(t,new n(r-1));break}case"<":{const t=e.value??this.popStack(),n=this.popStack();this.pushStackBool(n.compareTo(t)<0);break}case"<=":{const t=e.value??this.popStack(),n=this.popStack();this.pushStackBool(n.compareTo(t)<=0);break}case"==":{const t=e.value??this.popStack(),n=this.popStack();this.pushStackBool(0==n.compareTo(t));break}case"!=":{const t=e.value??this.popStack(),n=this.popStack();this.pushStackBool(0!=n.compareTo(t));break}case">":{const t=e.value??this.popStack(),n=this.popStack();this.pushStackBool(n.compareTo(t)>0);break}case">=":{const t=e.value??this.popStack(),n=this.popStack();this.pushStackBool(n.compareTo(t)>=0);break}case"&&":this.pushStackBool(this.getBoolArg(e)&&this.popStackBool());break;case"||":this.pushStackBool(this.getBoolArg(e)||this.popStackBool());break;case"!":this.pushStackBool(!this.popStackBool())}}tryCallReturn(){const e=this._stackTrace.pop();return null!=e&&(this._currentScope=e.scope,this._lineCounter=e.lineNumber,this.currentCode=e.function,!0)}callReturn(){if(!this.tryCallReturn())throw new Error(`${this.getScopeLine()}: Unable to return, call stack empty`)}getArgs(e){if(0===e)return p.Empty;let t=!1;const n=new Array(e);for(let r=0;r<e;r++){const s=this.popStack();s instanceof p&&s.isArgumentValue&&(t=!0),n[e-r-1]=s}if(t){let e=[];for(const t of n)t instanceof p&&t.isArgumentValue?e=e.concat(t.value):e.push(t);return new p(e,!0)}return new p(n,!0)}getNumArg(e){if(null==e.value)return this.popStackNumber();if(s(e.value))return e.value.value;throw new Error(`${this.getScopeLine()}: Error attempt to get number argument`)}getBoolArg(e){if(null==e.value)return this.popStackBool();if(i(e.value))return e.value.value;throw new Error(`${this.getScopeLine()}: Error attempt to get boolean argument`)}jump(e){const t=this.currentCode.labels[e];if(null==t)throw new Error(`${this.getScopeLine()}: Unable to jump to label: ${e}`);this._lineCounter=t}callFunction(e,t,n){const r=this.getArgs(t);e.invoke(this,r,n)}executeFunction(e,t,n=!1){n&&this.pushCurrentToStackTrace(),this.currentCode=e,this._currentScope=new a(this._currentScope),this._lineCounter=0;const r=Math.min(t.value.length,e.parameters.length);let s=0;for(;s<r;s++){const n=e.parameters[s];if(n.startsWith("...")){t=y(t,s,-1),this._currentScope.define(n.substring(3),t),s++;break}this._currentScope.define(n,t.value[s])}if(s<e.parameters.length){const t=e.parameters[s];if(!t.startsWith("..."))throw new Error("Function called without enough arguments: "+e.name);this._currentScope.define(t.substring(3),p.Empty)}}pushCurrentToStackTrace(){this.pushToStackTrace({lineNumber:this._lineCounter,scope:this._currentScope,function:this.currentCode})}pushToStackTrace(e){if(this._stackTrace.length>=this._stackSize)throw new Error(`${this.getScopeLine()}: Unable to push to stack trace, stack is full`);this._stackTrace.push(e)}pushStack(e){if(this._stack.length>=this._stackSize)throw new Error(`${this.getScopeLine()}: Unable to push, stack full`);this._stack.push(e)}pushStackNumber(e){this.pushStack(new n(e))}pushStackString(e){this.pushStack(new c(e))}pushStackBool(e){this.pushStack(new o(e))}popStack(){const e=this._stack.pop();if(void 0===e)throw new Error(`${this.getScopeLine()}: Popped empty stack`);return e}popStackCast(e){const t=this.popStack();if(e(t))return t;throw new Error(`${this.getScopeLine()}: Pop stack cast error`)}popStackNumber(){const e=this._stack.pop();if(!s(e))throw new Error(`${this.getScopeLine()}: Pop stack error, not a number`);return e.value}popStackBool(){const e=this._stack.pop();if(!i(e))throw new Error(`${this.getScopeLine()}: Pop stack error, not a boolean`);return e.value}peekStack(){if(0===this._stack.length)throw new Error(`${this.getScopeLine()}: Peek empty stack`);return this._stack[this._stack.length-1]}createStackTrace(){const e=[this.debugScopeLine(this.currentCode,this._lineCounter-1)];for(let t=this.stackTrace.length-1;t>=0;t--){const n=this._stackTrace[t];e.push(this.debugScopeLine(n.function,n.lineNumber))}return e}debugScopeLine(e,t){if(t>=e.code.length)return`[${e.name}]:${t-1}: end of code`;if(t<0)return`[${e.name}]:${t-1}: before start of code`;const n=e.code[t],r=null!=n.value?n.value.toString():"<empty>";return`[${e.name}]:${t-1}:${n.operator}: [${r}]`}getScopeLine(){return`${this.currentCode.name}:${this._lineCounter}`}}function T(e){let t="\0",n=!1,r=!1,s="",a=0;const o=[];for(;a<e.length;){const i=e.charAt(a++);if(r)"\n"!==i&&"\r"!==i||(r=!1);else if("\0"!=t){if(n){switch(i){case'"':case"'":case"\\":s+=i;break;case"t":s+="\t";break;case"r":s+="\r";break;case"n":s+="\n"}n=!1;continue}if("\\"==i){n=!0;continue}s+=i,i==t&&(o.push(s),s="",t="\0")}else switch(i){case";":r=!0;break;case'"':case"'":t=i,s+=i;break;case"(":case")":case"{":case"}":s.length>0&&(o.push(s),s=""),o.push(i);break;case" ":case"\t":case"\n":case"\r":s.length>0&&(o.push(s),s="");break;default:s+=i}}return o}function E(e){const t=[];for(;e.length>0;)t.push(_(e));return new p(t)}function _(e){if(0===e.length)throw new Error("Unexpected end of tokens");const t=F(e);if("("===t){const t=[];for(;")"!==e[0];)t.push(_(e));return F(e),new p(t)}if(")"===t)throw new Error("Unexpected )");if("{"===t){const t={};for(;"}"!==e[0];){const n=_(e).toString(),r=_(e);t[n]=r}return F(e),new v(t)}if("}"===t)throw new Error("Unexpected }");return function(e){const t=parseFloat(e);if(!isNaN(t))return new n(t);if("true"===e)return o.True;if("false"===e)return o.False;if("null"===e)return m.Value;const r=e[0],s=e[e.length-1];return'"'===r&&'"'===s||"'"===r&&"'"===s?new c(e.substring(1,e.length-1)):new x(e)}(t)}function F(e){if(0===e.length)throw new Error("Unable to pop empty list");const t=e[0];return e.splice(0,1),t}class L{static Empty=new L(a.Empty,I.Empty);constructor(e,t){this.builtinScope=e,this.code=t}}class j{constructor(e){this.value=e}typename(){return"function"}toString(){return"function:"+this.value.name}compareTo(e){return this===e||e instanceof j&&this.value===e.value?0:1}invoke(e,t,n){e.executeFunction(this.value,t,n)}}function P(e,t){return{operator:e,value:t}}function A(e){return{label:e}}class V{builtinScope=new a;labelCount=0;loopStack=[];keywordParsingStack=[];parseFromText(e){const t=E(T(e)),n=this.parseGlobalFunction(t),r=new a;return r.combineScope(this.builtinScope),new L(r,n)}parse(e){if(e instanceof p){if(0===e.value.length)return[];const t=e.value[0];if(t instanceof x){const n=t.toString();if(t.isLabel)return[A(n)];const r=this.parseKeyword(n,e);if(r.length>0)return r;this.keywordParsingStack.push("func-call");let s=e.value.slice(1).map((e=>this.parse(e))).flat(1);return s=s.concat(this.optimiseCallSymbolValue(t.value,e.value.length-1)),this.keywordParsingStack.pop(),s}}else if(e instanceof x&&!e.isLabel)return this.optimiseGetSymbolValue(e.value);return[P("push",e)]}parseDefineSet(e,t){const n=t?"define":"set",r=this.parse(e.value[e.value.length-1]);for(let t=e.value.length-2;t>=1;t--)r.push(P(n,e.value[t]));return r}parseLoop(e){if(e.value.length<3)throw new Error("Loop input has too few arguments");const t=this.labelCount++,n=`:LoopStart${t}`,r=`:LoopEnd${t}`;this.loopStack.push({start:n,end:r});const s=e.value[1];let a=[A(n),...this.parse(s)];a.push(P("jumpFalse",new c(r)));for(let t=2;t<e.value.length;t++)a=a.concat(this.parse(e.value[t]));return a.push(P("jump",new c(n))),a.push(A(r)),this.loopStack.pop(),a}parseCond(e,t){if(e.value.length<3)throw new Error("Condition input has too few inputs");if(e.value.length>4)throw new Error("Condition input has too many inputs!");const n=this.labelCount++,r=`:CondElse${n}`,s=`:CondEnd${n}`,a=4===e.value.length,o=t?"jumpFalse":"jumpTrue",i=e.value[1],u=e.value[2];let l=this.parse(i);if(a){l.push(P(o,new c(r))),l=l.concat(this.parseFlatten(u)),l.push(P("jump",new c(s))),l.push(A(r));const t=e.value[3];l=l.concat(this.parseFlatten(t))}else l.push(P(o,new c(s))),l=l.concat(this.parseFlatten(u));return l.push(A(s)),l}parseFlatten(e){return e.value.every(f)?e.value.map((e=>this.parse(e))).flat(1):this.parse(e)}parseLoopJump(e,t){if(0===this.loopStack.length)throw new Error(`Unexpected ${e} outside of loop`);const n=this.loopStack[this.loopStack.length-1];return[P("jump",new c(t?n.start:n.end))]}parseFunction(e){let t="",n=0;if((e.value[1]instanceof x||e.value[1]instanceof c)&&(t=e.value[1].toString(),n=1),!f(e.value[1+n]))throw new Error("Function needs parameter array");const r=e.value[1+n].arrayValues().map((e=>e.toString())),s=e.value.slice(2+n).map((e=>this.parse(e))).flat(1);return this.processTempFunction(r,s,t)}parseGlobalFunction(e){const t=e.value.map((e=>this.parse(e))).flat(1);return this.processTempFunction([],t,"global")}processTempFunction(e,t,n){const r={},s=[];for(const e of t)void 0!==e.label&&""!=e.label?r[e.label]=s.length:void 0!==e.operator&&s.push({operator:e.operator,value:e.value});return new I(s,e,r,n)}parseChangeVariable(e,t){const r=new c(e.toString());return[P("get",r),P("callDirect",new p([t,new n(1)])),P("set",r)]}parseJump(e){let t=this.parse(e.value[1]);return 1===t.length&&"push"===t[0].operator&&void 0!==t[0].value?[P("jump",t[0].value)]:(t.push(P("push")),t)}parseReturn(e){const t=e.value.slice(1).map((e=>this.parse(e))).flat(1);return t.push(P("return")),t}parseFunctionKeyword(e){const t=this.parseFunction(e),n=[P("push",new j(t))],r=this.keywordParsingStack.length>1?this.keywordParsingStack[this.keywordParsingStack.length-1]:"function";return t.hasName&&"function"===r&&n.push(P("define",new c(t.name))),n}parseNegative(e){if(e.value.length>=3)return this.parseOperator("-",e);if(2===e.value.length){if(s(e.value[1]))return[P("push",new n(-e.value[1].value))];const t=this.parse(e.value[1]);return t.push(P("unaryNegative")),t}throw new Error("Negative/Sub operator expects at least 1 input")}parseOnePushInput(e,t){if(t.value.length<2)throw new Error(`Expecting at least 1 input for: ${e}`);let n=[];for(let r=1;r<t.value.length;r++)n=n.concat(this.parse(t.value[r])),n.push(P(e));return n}parseOperator(e,t){if(t.value.length<3)throw new Error(`Expecting at least 3 inputs for: ${e}`);let n=this.parse(t.value[1]);for(let r=2;r<t.value.length;r++){const a=t.value[r];s(a)?n.push(P(e,a)):(n=n.concat(this.parse(a)),n.push(P(e)))}return n}parseOneVariableUpdate(e,t){if(t.value.length<2)throw new Error(`Expecting at least 1 input for: ${e}`);let n=[];for(let r=1;r<t.value.length;r++){const s=new c(t.value[r].toString());n.push(P(e,s))}return n}parseStringConcat(e){const t=e.value.slice(1).map((e=>this.parse(e))).flat(1);return t.push(P("stringConcat",new n(e.value.length-1))),t}transformAssignmentOperator(e){let t=e.value[0].toString();t=t.substring(0,t.length-1);const n=e.value[1].toString(),r=[...e.value];r[0]=new x(t);const s=[new x("set"),new x(n),new p(r)];return this.parse(new p(s))}parseKeyword(e,t){let n=null;switch(this.keywordParsingStack.push(e),e){case"function":n=this.parseFunctionKeyword(t);break;case"continue":n=this.parseLoopJump("continue",!0);break;case"break":n=this.parseLoopJump("break",!1);break;case"set":n=this.parseDefineSet(t,!1);break;case"define":n=this.parseDefineSet(t,!0);break;case"loop":n=this.parseLoop(t);break;case"if":n=this.parseCond(t,!0);break;case"unless":n=this.parseCond(t,!1);break;case"jump":n=this.parseJump(t);break;case"return":n=this.parseReturn(t);break;case"+":case"*":case"/":case"<":case"<=":case"==":case"!=":case">":case">=":case"&&":case"||":n=this.parseOperator(e,t);break;case"-":n=this.parseNegative(t);break;case"++":case"--":n=this.parseOneVariableUpdate(e,t);break;case"!":n=this.parseOnePushInput("!",t);break;case"$":n=this.parseStringConcat(t);break;case"+=":case"-=":case"*=":case"/=":case"&&=":case"||=":case"$=":n=this.transformAssignmentOperator(t)}return this.keywordParsingStack.pop(),null!=n?n:[]}optimiseCallSymbolValue(e,t){const r=new n(t),s=V.isGetPropertyRequest(e),a=this.builtinScope.get(s.parentKey);if(void 0!==a){let t;if(s.isPropertyRequest&&void 0!==(t=N(a,s.property))){if(S(t)){return[P("callDirect",new p([t,r]))]}throw new Error(`Attempting to call a value that is not a function: ${e} = ${t.toString()}`)}if(!s.isPropertyRequest){if(S(a)){return[P("callDirect",new p([a,r]))]}throw new Error(`Attempting to call a value that is not a function: ${e} = ${a.toString()}`)}}const o=[P("get",new c(s.parentKey))];return s.isPropertyRequest&&o.push(P("getProperty",s.property)),o.push(P("call",r)),o}optimiseGetSymbolValue(e){let t=!1;e.startsWith("...")&&(t=!0,e=e.substring(3));const n=[],r=V.isGetPropertyRequest(e),s=this.builtinScope.get(r.parentKey);if(void 0!==s)if(r.isPropertyRequest){const e=N(s,r.property);void 0!==e?n.push(P("push",e)):(n.push(P("push",s)),n.push(P("getProperty",r.property)))}else r.isPropertyRequest||n.push(P("push",s));else n.push(P("get",new c(r.parentKey))),r.isPropertyRequest&&n.push(P("getProperty",r.property));return t&&n.push(P("toArgument",void 0)),n}static isGetPropertyRequest(e){if(e.includes(".")){const t=e.split(".");return{isPropertyRequest:!0,parentKey:t[0],property:new p(t.slice(1).map((e=>new x(e))))}}return{isPropertyRequest:!1,parentKey:e,property:p.Empty}}}const B=Math.PI/180,M=function(){const e=new a,r={E:new n(Math.E),PI:new n(Math.PI),DegToRad:new n(B),sin:new t(((e,t)=>{e.pushStackNumber(Math.sin(t.getNumber(0)))}),"math.sin"),cos:new t(((e,t)=>{e.pushStackNumber(Math.cos(t.getNumber(0)))}),"math.cos"),tan:new t(((e,t)=>{e.pushStackNumber(Math.tan(t.getNumber(0)))}),"math.tan"),exp:new t(((e,t)=>{e.pushStackNumber(Math.exp(t.getNumber(0)))}),"math.exp"),ceil:new t(((e,t)=>{e.pushStackNumber(Math.ceil(t.getNumber(0)))}),"math.ceil"),floor:new t(((e,t)=>{e.pushStackNumber(Math.floor(t.getNumber(0)))}),"math.floor"),round:new t(((e,t)=>{e.pushStackNumber(Math.round(t.getNumber(0)))}),"math.round"),isFinite:new t(((e,t)=>{e.pushStackBool(Number.isFinite(t.getNumber(0)))}),"math.isFinite"),isNaN:new t(((e,t)=>{e.pushStackBool(isNaN(t.getNumber(0)))}),"math.isNaN"),parse:new t(((e,t)=>{const n=t.getIndex(0);s(n)?e.pushStack(n):e.pushStackNumber(parseFloat(n.toString()))}),"math.parse"),log:new t(((e,t)=>{e.pushStackNumber(Math.log(t.getNumber(0)))}),"math.log"),abs:new t(((e,t)=>{e.pushStackNumber(Math.abs(t.getNumber(0)))}),"math.abs"),max:new t(((e,t)=>{let n=t.value[0];for(let e=1;e<t.value.length;e++){const r=t.value[e];r.compareTo(n)>0&&(n=r)}e.pushStack(n)}),"math.max"),min:new t(((e,t)=>{let n=t.value[0];for(let e=1;e<t.value.length;e++){const r=t.value[e];r.compareTo(n)<0&&(n=r)}e.pushStack(n)}),"math.min"),sum:new t(((e,t)=>{let n=0;for(let e=0;e<t.value.length;e++){const r=t.value[e];if(!s(r))throw new Error("Addition operator expects all numbers");n+=r.value}e.pushStackNumber(n)}),"math.sum")};return e.define("math",new v(r)),e}();const K=function(){const e=new a,n={join:new t(((e,t)=>{if(t.value.length<2)throw new Error("Not enough arguments for string join");const n=t.value[0],r=t.value.slice(1).join(n.toString());e.pushStackString(r)}),"string.join"),length:new t(((e,t)=>{const n=t.getString(0);e.pushStackNumber(n.length)}),"string.length"),get:new t(((e,t)=>{const n=t.getIndexCast(0,l),r=t.getNumber(1);e.pushStackString(n.value[n.getIndex(r)])}),"string.get"),set:new t(((e,t)=>{const n=t.getIndexCast(0,l),r=t.getNumber(1),s=t.getIndex(2).toString();e.pushStack(function(e,t,n){return t=e.getIndex(t),new c(`${e.value.substring(0,t)}${n}${e.value.substring(t+1)}`)}(n,r,s))}),"string.set"),insert:new t(((e,t)=>{const n=t.getIndexCast(0,l),r=t.getNumber(1),s=t.getIndex(2).toString();e.pushStack(function(e,t,n){return t=e.getIndex(t),new c(`${e.value.substring(0,t)}${n}${e.value.substring(t)}`)}(n,r,s))}),"string.insert"),substring:new t(((e,t)=>{const n=t.getIndexCast(0,l),r=t.getNumber(1),s=t.getNumber(2);e.pushStack(function(e,t,n){return t=e.getIndex(t),new c(e.value.substring(t,t+n))}(n,r,s))}),"string.substring"),removeAt:new t(((e,t)=>{const n=t.getIndexCast(0,l),r=t.getNumber(1);e.pushStack(function(e,t){return t=e.getIndex(t),new c(`${e.value.substring(0,t)}${e.value.substring(t+1)}`)}(n,r))}),"string.removeAt"),removeAll:new t(((e,t)=>{const n=t.getIndexCast(0,l),r=t.getIndex(1).toString();e.pushStack(function(e,t){return new c(e.value.replace(t,""))}(n,r))}),"string.removeAll")};return e.define("string",new v(n)),e}();const R=function(){const e=new a,n={set:new t(((e,t)=>{const n=t.getIndexCast(0,b),r=t.getString(1),s=t.getIndex(2);e.pushStack(function(e,t,n){return new v({...e.value,[t]:n})}(n,r,s))}),"object.set"),get:new t(((e,t)=>{const n=function(e,t){const n=e.value[t];return null!=n?n:void 0}(t.getIndexCast(0,b),t.getString(1));void 0!==n?e.pushStack(n):e.pushStack(m.Value)}),"object.get"),removeKey:new t(((e,t)=>{const n=t.getIndexCast(0,b),r=t.getString(1);e.pushStack(function(e,t){if(!e.value.hasOwnProperty(t))return e;const n={...e.value};return delete n[t],new v(n)}(n,r))}),"object.removeKey"),removeValues:new t(((e,t)=>{const n=t.getIndexCast(0,b),r=t.getIndex(1);e.pushStack(function(e,t){const n={};for(const r in e.value)0!==e.value[r].compareTo(t)&&(n[r]=e.value[r]);return new v(n)}(n,r))}),"object.removeValues"),keys:new t(((e,t)=>{const n=t.getIndexCast(0,b);e.pushStack(new p(n.keys.map((e=>new c(e)))))}),"object.keys"),values:new t(((e,t)=>{const n=t.getIndexCast(0,b);var r;e.pushStack((r=n,new p(Object.values(r.value))))}),"object.values"),length:new t(((e,t)=>{const n=t.getIndexCast(0,b);e.pushStackNumber(n.keys.length)}),"object.length")};return e.define("object",new v(n)),e}();const U=function(){const e=new a;return e.defineFunc("toString",((e,t)=>{e.pushStackString(t.getIndex(0).toString())})),e.defineFunc("typeof",((e,t)=>{e.pushStackString(t.getIndex(0).typename())})),e.defineFunc("compareTo",((e,t)=>{e.pushStackNumber(t.getIndex(0).compareTo(t.getIndex(1)))})),e.defineFunc("print",((e,t)=>{console.log(t.value.map((e=>e.toString())).join(""))})),e}();let G;var O;function D(e,t){t&G.math&&e.combineScope(M),t&G.string&&e.combineScope(K),t&G.array&&e.combineScope(k),t&G.object&&e.combineScope(R),t&G.misc&&e.combineScope(U)}(O=G||(G={}))[O.math=1]="math",O[O.string=2]="string",O[O.array=4]="array",O[O.object=8]="object",O[O.misc=16]="misc",O[O.all=31]="all",globalThis.runStdLib=function(t){const n=e(t);if(!1===n)return;const r=new V;D(r.builtinScope,G.all),r.builtinScope.defineFunc("print",((e,t)=>{const r=t.value.map((e=>e.toString())).join("");console.log(r),n.output.innerHTML+=r+"<br/>"}));const s=r.parseFromText(n.text);new $(16).execute(s)};const q=function(){const e=new a,n={pick:new t(((e,t)=>{let n=t;if(1===t.value.length){const e=t.getIndexCast(0,g);e&&(n=e)}const r=Math.floor(Math.random()*n.arrayValues().length);e.pushStack(n.arrayValues()[r])}),"random.pick")};return e.define("random",new v(n)),e}(),H=new a;H.defineFunc("setBackground",((e,t)=>{document.body.setAttribute("background",t.getString(0))})),H.defineFunc("setTheme",((e,t)=>{document.body.setAttribute("theme",t.getString(0))})),globalThis.runPageSetup=function(){const t=e("codePageSetup");if(!1===t)return;const n=new V;D(n.builtinScope,G.all),n.builtinScope.combineScope(H),n.builtinScope.combineScope(q),n.builtinScope.defineFunc("print",((e,n)=>{const r=n.value.map((e=>e.toString())).join("");console.log(r),t.output.innerHTML+=r+"<br/>"}));const r=n.parseFromText(t.text);new $(16).execute(r)};const J=new a;J.defineFunc("rand",((e,t)=>{e.pushStackNumber(Math.random())})),globalThis.runPerfTest=function(){const t=e("codePerfTest");if(!1===t)return;const n=new V;n.builtinScope.combineScope(J),n.builtinScope.defineFunc("print",((e,n)=>{const r=n.value.map((e=>e.toString())).join("");console.log(r),t.output.innerHTML+=r+"<br/>"}));const r=n.parseFromText(t.text),s=new $(16),a=Date.now();s.execute(r);const o=Date.now();t.output.innerHTML+=`Time taken: ${o-a}ms <br/>`};
//# sourceMappingURL=index.215d08d6.js.map
